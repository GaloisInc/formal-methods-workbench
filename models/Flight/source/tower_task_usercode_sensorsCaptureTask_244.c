/* This file has been autogenerated by Ivory
 * Compiler version  0.1.0.0
 */
#include "tower_task_usercode_sensorsCaptureTask_244.h"

struct position position_247;

uint32_t periodDue10_machine_sensors_capture_253_265;

bool state_active_machine_sensors_capture_253 = false;

uint32_t state_machine_sensors_capture_253 = 0U;

void nodeInit_sensorsCaptureTask_244()
{
    begin_machine_sensors_capture_253();
}

void eventhandler_sensorsCaptureTask_244_chan216_252(const
                                                     struct position* n_var0)
{
    if (&position_247 != n_var0) {
        memcpy(&position_247, n_var0, sizeof(struct position));
    } else {
        ASSERTS(false);
    }
}

void sensorsSetPosition()
{
    uint32_t n_deref0 = (&position_247)->fix;
    uint8_t n_deref1 = (&position_247)->num_sv;
    
    sensors_set_gps_fix(n_deref0 == 1U, n_deref0 == 2U, n_deref1);
    
    int32_t n_deref2 = (&position_247)->lat;
    int32_t n_deref3 = (&position_247)->lon;
    
    sensors_set_gps_position(n_deref2, n_deref3);
    
    int32_t n_deref4 = (&position_247)->vnorth;
    int32_t n_deref5 = (&position_247)->veast;
    int32_t n_deref6 = (&position_247)->vdown;
    uint32_t n_deref7 = (&position_247)->vground;
    float n_deref8 = (&position_247)->heading;
    
    sensors_set_gps_velocity(n_deref4, n_deref5, n_deref6, n_deref7, n_deref8);
}

void eventhandler_sensorsCaptureTask_244_chan257_newstate_init_264(const
                                                                   uint32_t* n_var0)
{
    uint32_t n_deref0 = *n_var0;
    
    if (n_deref0 == 0U) {
        *&state_machine_sensors_capture_253 = n_deref0;
        
        uint32_t n_r1 = tower_gettimemillis();
        uint32_t n_local2 = n_r1;
        uint32_t* n_ref3 = &n_local2;
        struct sensors_result n_local4 = {.valid =false};
        struct sensors_result* n_ref5 = &n_local4;
        
        emitFromTask_sensorsCaptureTask_244_chan0_246(n_ref5);
        sensors_begin(false);
        
        uint32_t n_local6 = 1U;
        uint32_t* n_ref7 = &n_local6;
        
        emitFromTask_sensorsCaptureTask_244_chan257_259(n_ref7);
    }
}

void eventhandler_sensorsCaptureTask_244_per1_captureloop_266(const
                                                              uint32_t* n_var0)
{
    uint32_t n_deref0 = *&state_machine_sensors_capture_253;
    
    if (n_deref0 == 1U) {
        uint32_t n_deref1 = *n_var0;
        uint32_t n_deref2 = *&periodDue10_machine_sensors_capture_253_265;
        
        if (n_deref2 <= n_deref1) {
            sensorsSetPosition();
            sensors_update();
            
            uint32_t n_r3 = tower_gettimemillis();
            float n_local4[3U] = {};
            float* n_ref5 = n_local4;
            
            sensors_get_rpy((float*) n_ref5);
            
            float n_deref6 = n_ref5[0];
            float n_deref7 = n_ref5[1];
            float n_deref8 = n_ref5[2];
            float n_local9[3U] = {};
            float* n_ref10 = n_local9;
            
            sensors_get_omega((float*) n_ref10);
            
            float n_deref11 = n_ref10[0];
            float n_deref12 = n_ref10[1];
            float n_deref13 = n_ref10[2];
            float n_r14 = sensors_get_baro_alt();
            struct sensors_result n_local15 = {.valid =true, .roll =n_deref6,
                                               .pitch =n_deref7, .yaw =n_deref8,
                                               .omega_x =n_deref11, .omega_y =
                                               n_deref12, .omega_z =n_deref13,
                                               .baro_alt =n_r14, .xacc =0.0f,
                                               .yacc =0.0f, .zacc =0.0f, .time =
                                               n_r3};
            struct sensors_result* n_ref16 = &n_local15;
            
            emitFromTask_sensorsCaptureTask_244_chan0_246(n_ref16);
            ASSERTS(4294967295U - n_deref2 >= 10U);
            *&periodDue10_machine_sensors_capture_253_265 = n_deref2 + 10U;
        }
    }
}

void eventhandler_sensorsCaptureTask_244_chan257_newstate_captureloop_267(const
                                                                          uint32_t* n_var0)
{
    uint32_t n_deref0 = *n_var0;
    
    if (n_deref0 == 1U) {
        *&state_machine_sensors_capture_253 = n_deref0;
        
        uint32_t n_r1 = tower_gettimemillis();
        uint32_t n_local2 = n_r1;
        uint32_t* n_ref3 = &n_local2;
        uint32_t n_deref4 = *n_ref3;
        
        ASSERTS(4294967295U - n_deref4 >= 10U);
        *&periodDue10_machine_sensors_capture_253_265 = n_deref4 + 10U;
    }
}

void begin_machine_sensors_capture_253()
{
    bool n_deref0 = *&state_active_machine_sensors_capture_253;
    
    if (n_deref0) { } else {
        *&state_active_machine_sensors_capture_253 = true;
        
        uint32_t n_local1 = 0U;
        uint32_t* n_ref2 = &n_local1;
        
        emitFromTask_sensorsCaptureTask_244_chan257_259(n_ref2);
    }
}

bool active_machine_sensors_capture_253()
{
    bool n_deref0 = *&state_active_machine_sensors_capture_253;
    
    return n_deref0;
}